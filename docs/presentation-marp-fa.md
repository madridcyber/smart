---
marp: true
theme: default
paginate: true
backgroundColor: #fff
direction: rtl
style: |
  section {
    font-family: 'Vazir', 'Tahoma', sans-serif;
    direction: rtl;
    text-align: right;
  }
  h1 {
    color: #2563eb;
  }
  h2 {
    color: #1e40af;
  }
  table {
    font-size: 0.8em;
  }
  code {
    background-color: #f3f4f6;
    direction: ltr;
    text-align: left;
  }
  pre {
    direction: ltr;
    text-align: left;
  }
---

# پلتفرم مدیریت دانشگاه هوشمند

### پروژه درس تحلیل و طراحی نرم‌افزار

**نام دانشجو:** [نام شما]  
**درس:** تحلیل و طراحی نرم‌افزار  
**استاد:** دکتر فیضی  
**تاریخ:** [تاریخ جاری]

---

# معرفی پروژه

## پلتفرم دانشگاه هوشمند چیست؟

یک **پلتفرم میکروسرویس** برای مدیریت دانشگاه با ویژگی‌های:

- 🔐 **احراز هویت و مجوزدهی** - مبتنی بر JWT با RBAC
- 📅 **رزرو منابع** - اتاق‌ها و آزمایشگاه‌ها بدون رزرو مضاعف
- 🛒 **بازارچه** - محصولات و سفارشات با الگوی Saga
- 📝 **آزمون آنلاین** - ایجاد، شروع و ارسال با Circuit Breaker
- 📊 **داشبورد IoT** - سنسورهای زنده و ردیابی شاتل
- 📧 **اعلان‌ها** - الگوی Observer رویدادمحور

---

# معماری کلی

## معماری میکروسرویس

```
┌─────────────────────────────────────────────────────────────┐
│                    React SPA (فرانت‌اند)                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    API Gateway (Spring Cloud)                │
│              اعتبارسنجی JWT │ RBAC │ مسیریابی                 │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        ▼                     ▼                     ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│ سرویس احراز   │   │ سرویس رزرو   │   │ سرویس بازارچه │
│   هویت       │   │   منابع      │   │    (Saga)     │
└───────────────┘   └───────────────┘   └───────────────┘
```

---

# فناوری‌های استفاده شده

## پشته فناوری

| لایه | فناوری |
|------|--------|
| **بک‌اند** | Java 17, Spring Boot 3, Spring Cloud |
| **فرانت‌اند** | React 18, TypeScript, Vite |
| **پایگاه داده** | PostgreSQL (یک دیتابیس به ازای هر سرویس) |
| **کش توزیع شده** | Redis |
| **پیام‌رسانی** | RabbitMQ |
| **تاب‌آوری** | Resilience4j |
| **کانتینرسازی** | Docker, Docker Compose |
| **تست** | JUnit 5, Jest, MSW |

---

# الگوهای طراحی پیاده‌سازی شده

## ۷ الگوی طراحی

| الگو | محل | هدف |
|------|-----|-----|
| **Saga** | بازارچه → پرداخت | تراکنش‌های توزیع‌شده |
| **Circuit Breaker** | آزمون → اعلان | تحمل خطا |
| **Observer** | رویدادهای RabbitMQ | اتصال سست |
| **State** | چرخه حیات آزمون | مدیریت وضعیت |
| **Strategy** | ارائه‌دهندگان پرداخت | توسعه‌پذیری |
| **Repository** | همه سرویس‌ها | دسترسی به داده |
| **Factory** | ExamStateFactory | ایجاد اشیا |

---

# پیاده‌سازی الگوی Saga

## Saga خرید در بازارچه

```
┌──────────────────────────────────────────────────────────┐
│                    SAGA ORCHESTRATOR                      │
│                  (سرویس بازارچه)                          │
└──────────────────────────────────────────────────────────┘
                          │
    مرحله ۱: ایجاد سفارش (PENDING)
    مرحله ۲: مجوز پرداخت ──────► سرویس پرداخت
    مرحله ۳: کاهش موجودی
    مرحله ۴: تأیید سفارش (CONFIRMED)
    مرحله ۵: انتشار رویداد ──────────► RabbitMQ
                          │
         ┌────────────────┴────────────────┐
         │         جبران‌سازی              │
         │  • لغو پرداخت                   │
         │  • علامت‌گذاری سفارش CANCELED    │
         └─────────────────────────────────┘
```

---

# الگوی Circuit Breaker

## سرویس آزمون → سرویس اعلان

```java
@CircuitBreaker(name = "notificationCb", 
                fallbackMethod = "notifyFallback")
public void notifyExamStart(UUID examId, String tenantId) {
    // فراخوانی HTTP به سرویس اعلان
}

public void notifyFallback(UUID examId, String tenantId, 
                           Throwable t) {
    log.warn("اعلان ناموفق: {}", t.getMessage());
    // آزمون همچنان با موفقیت شروع می‌شود!
}
```

**مزایا:**
- شروع آزمون حتی در صورت خرابی اعلان‌ها موفق است
- جلوگیری از خرابی‌های آبشاری
- بازیابی خودکار هنگام سالم شدن سرویس

---

# معماری رویدادمحور

## الگوی Observer از طریق RabbitMQ

```
┌─────────────────┐     order.confirmed     ┌─────────────────┐
│   سرویس        │ ──────────────────────► │                 │
│   بازارچه      │                         │  سرویس اعلان    │
└─────────────────┘                         │                 │
                                            │  (Observer)     │
┌─────────────────┐     exam.started        │                 │
│   سرویس        │ ──────────────────────► │                 │
│   آزمون        │                         └─────────────────┘
└─────────────────┘                                 │
                                                    ▼
                                           NotificationLog
                                              (پایگاه داده)
```

---

# الگوی State - چرخه حیات آزمون

## ماشین وضعیت آزمون

```
    ┌─────────┐
    │  DRAFT  │ ◄── وضعیت اولیه
    └────┬────┘
         │ schedule()
         ▼
    ┌─────────────┐
    │  SCHEDULED  │
    └──────┬──────┘
           │ start()
           ▼
    ┌─────────┐
    │  LIVE   │ ◄── پذیرش پاسخ‌ها
    └────┬────┘
         │ close()
         ▼
    ┌─────────┐
    │ CLOSED  │ ◄── وضعیت نهایی
    └─────────┘
```

---

# استراتژی چندمستأجری

## جداسازی مستأجر در سطح ردیف

```sql
-- هر جدول مرتبط با مستأجر دارای ستون tenant_id است
CREATE TABLE products (
    id UUID PRIMARY KEY,
    tenant_id VARCHAR(100) NOT NULL,  -- شناسه دانشکده
    name VARCHAR(255),
    price DECIMAL(10,2),
    stock INTEGER
);

-- همه کوئری‌ها بر اساس مستأجر فیلتر می‌شوند
SELECT * FROM products WHERE tenant_id = 'engineering';
```

**اجرا:**
- JWT شامل claim مستأجر است
- Gateway هدر `X-Tenant-Id` را تزریق می‌کند
- سرویس‌ها همه کوئری‌ها را بر اساس مستأجر فیلتر می‌کنند

---

# معماری امنیتی

## احراز هویت JWT و RBAC

```
┌─────────────────────────────────────────────────────────┐
│                      توکن JWT                            │
├─────────────────────────────────────────────────────────┤
│  {                                                       │
│    "sub": "user-uuid",                                   │
│    "role": "TEACHER",                                    │
│    "tenant": "engineering",                              │
│    "exp": 1234567890                                     │
│  }                                                       │
└─────────────────────────────────────────────────────────┘

Gateway توکن JWT را اعتبارسنجی و هدرها را تزریق می‌کند:
  • X-User-Id
  • X-User-Role  
  • X-Tenant-Id
```

---

# الگوریتم جلوگیری از رزرو مضاعف

## سرویس رزرو - امن در برابر همزمانی

```java
@Transactional
public Reservation createReservation(CreateReservationRequest req) {
    // قفل بدبینانه روی منبع
    List<Reservation> overlapping = reservationRepository
        .findOverlappingReservations(
            req.getResourceId(),
            req.getStartTime(),
            req.getEndTime(),
            tenantId
        );
    
    if (!overlapping.isEmpty()) {
        throw new ConflictException("منبع قبلاً رزرو شده است");
    }
    
    return reservationRepository.save(reservation);
}
```

---

# نیازمندی‌های غیرعملکردی

## انطباق با NFR

| NFR | نیازمندی | پیاده‌سازی |
|-----|----------|------------|
| **NFR-S01** | مقیاس‌پذیری ۱۰ برابر | سرویس‌های Stateless |
| **NFR-MT01** | جداسازی مستأجر | سطح ردیف + هدرها |
| **NFR-P01** | پاسخ <400ms | کش، ایندکس |
| **NFR-SE01** | JWT + RBAC | Gateway + سرویس‌ها |
| **NFR-R01** | جداسازی IoT | سرویس‌های مجزا |
| **NFR-R02** | بدون رزرو مضاعف | قفل بدبینانه |
| **NFR-MN01** | ۵+ الگو | ۷ الگو پیاده‌سازی شده |
| **NFR-MN02** | ADRها | ۵ ADR مستند شده |

---

# تست‌ها

## پوشش جامع تست

| نوع | ابزار | پوشش |
|-----|-------|------|
| **تست یکپارچگی بک‌اند** | JUnit 5 + Spring Test | همه سرویس‌ها |
| **تست همزمانی** | رشته‌های موازی | رزرو مضاعف |
| **تست Saga** | یکپارچگی | موفقیت + جبران |
| **تست Circuit Breaker** | Resilience4j | رفتار fallback |
| **تست فرانت‌اند** | Jest + RTL + MSW | همه صفحات |

---

# مستندات تحویلی

## مستندات کامل

| مستند | توضیحات |
|-------|---------|
| **README.md** | معرفی پروژه و راهنما |
| **architecture.md** | نمودارهای C4، الگوها، نگاشت NFR |
| **api-overview.md** | همه endpointهای HTTP |
| **ADR-001 تا 005** | تصمیمات معماری |
| **AI_Log.md** | خلاصه تعامل با AI |
| **Learning_Report.md** | بازتاب‌های فنی |
| **presentation.md** | اسلایدهای ارائه |
| **project-checklist.md** | انطباق با نیازمندی‌ها |

---

# نتیجه‌گیری

## خلاصه پروژه

✅ **۷ میکروسرویس** + API Gateway  
✅ **۷ الگوی طراحی** پیاده‌سازی شده  
✅ **همه NFRها** برآورده شده  
✅ **مستندات کامل** با ADRها  
✅ **تست جامع** (بک‌اند + فرانت‌اند)  
✅ **Docker Compose** برای استقرار کامل  
✅ **React SPA** با مسیرهای محافظت‌شده  

### سؤالات؟

---

# ضمیمه: دستورات اجرا

```bash
# شروع همه چیز
docker compose up --build

# نقاط دسترسی:
# - فرانت‌اند: http://localhost:3000
# - API Gateway: http://localhost:8080
# - RabbitMQ UI: http://localhost:15672 (guest/guest)
```
